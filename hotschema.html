
<script src="https://docs.handsontable.com/4.0.0/components/handsontable/dist/handsontable.full.js"></script>
<link type="text/css" rel="stylesheet" href="https://docs.handsontable.com/4.0.0/components/handsontable/dist/handsontable.full.min.css">
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.5.2/ajv.bundle.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/4.1.7/ajv.bundle.js"></script>
<script src="hotschema.js"></script>
<script src="example_schema.js"></script>
<div id="example1" class="hot handsontable htRowHeaders htColumnHeaders"></div>
<button onClick="addRow()">Add row</button><button onClick="logData()">Show data</button>

<script>

var container1 = document.getElementById('example1'),
    hot1,
    commentsPlugin;


console.log('schema',example_schemas.veggie);
var coldefs = schema2HotCols(example_schemas.veggie);
var colHeaders = schema2HotHeaders(example_schemas.veggie);
console.log('coldefs',coldefs);

var ajv = new Ajv({allErrors: true}); // options can be passed, e.g. {allErrors: true}
var validate = ajv.compile(example_schemas.veggie);
//test({score: "sdfsdf"});
function test(data) {
  var valid = validate(data);
  if (valid) console.log('Valid!');
  else{
    console.log(data,validate.errors);
    console.log('Invalid: ' + ajv.errorsText(validate.errors));
  }
}


hot1 = new Handsontable(container1, {
  data: [{}],
  columns: coldefs,
  rowHeaders: true,
  comments: true,
  colHeaders: colHeaders,
  contextMenu: ['copy', 'cut'],
  manualColumnResize: true,
  afterValidate: function(isValid, value, row, prop, source) {
	//This is necessary because it passes in some context, unlike the custom validators which only give the value.
    console.log('afterValidate',isValid,value,row,prop,source,this.propToCol(prop));
    var rowData = hot1.getSourceDataAtRow(row);
    rowData[prop] = value;
    console.log('row data',JSON.stringify(rowData));
    var valid = validate(rowData);
    var message = "Bad value."
    if (valid) console.log('Valid!');
    else{
      valid = true;
      for(var i in validate.errors){
        if (validate.errors[i].dataPath == '.'+prop){
          valid = false;
          message = validate.errors[i].message;
        }

      }
      if (!valid){
        console.log(JSON.stringify(validate.errors));
        console.log('Invalid: ' + ajv.errorsText(validate.errors));
        commentsPlugin.setCommentAtCell(row, this.propToCol(prop), message);
      }
      else {
        commentsPlugin.removeCommentAtCell(row, this.propToCol(prop), message);
      }
    }
    return valid && isValid;
  }
});
commentsPlugin = hot1.getPlugin('comments');

function logData(){
  var data = hot1.getSourceData();
  console.log(data);
  for (var i in data){
      console.log('validate',data[i]);
      test(data[i]);
  }

}
function addRow(){
  hot1.alter('insert_row');
}
function removeSelected(){
  hot1.getSelected()
}
</script>
